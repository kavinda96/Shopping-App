-- Create DB
CREATE DATABASE shopapp
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;

USE shopapp;

-- SHOPS
CREATE TABLE shops (
  id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(150) NOT NULL,
  description TEXT,
  address VARCHAR(255),
  photo_url VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- PRODUCTS
CREATE TABLE products (
  id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  shop_id INT UNSIGNED NOT NULL,
  name VARCHAR(150) NOT NULL,
  description TEXT,
  price_cents INT UNSIGNED NOT NULL,
  sku VARCHAR(64),
  stock INT DEFAULT 0,
  photo_url VARCHAR(255),
  is_active TINYINT(1) DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_products_shop
    FOREIGN KEY (shop_id) REFERENCES shops(id)
    ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE INDEX idx_products_shop   ON products(shop_id);
CREATE INDEX idx_products_active ON products(is_active);



DROP TABLE IF EXISTS cart_items;

CREATE TABLE cart_items (
  id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,               -- matches users.id (INT)
  product_id INT UNSIGNED NOT NULL,   -- matches products.id (INT UNSIGNED)
  qty INT UNSIGNED NOT NULL DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_user_product (user_id, product_id),
  KEY idx_user (user_id),
  CONSTRAINT fk_ci_user  FOREIGN KEY (user_id)    REFERENCES users(id)    ON DELETE CASCADE,
  CONSTRAINT fk_ci_prod  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

ALTER TABLE cart_items 
  MODIFY shop_id INT UNSIGNED NOT NULL;


ALTER TABLE cart_items
  ADD CONSTRAINT fk_ci_shop
  FOREIGN KEY (shop_id) REFERENCES shops(id)
  ON DELETE CASCADE;

CREATE TABLE IF NOT EXISTS promo_codes (
  id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  code VARCHAR(64) NOT NULL UNIQUE,
  type ENUM('percent','fixed') NOT NULL DEFAULT 'fixed',
  value_cents INT UNSIGNED DEFAULT 0,  -- used when type='fixed'
  percent TINYINT UNSIGNED DEFAULT 0,  -- used when type='percent' (0..100)
  active TINYINT(1) NOT NULL DEFAULT 1,
  starts_at DATETIME NULL,
  ends_at DATETIME NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO promo_codes (code, type, value_cents, active) VALUES ('FLAT5', 'fixed', 500, 1)
  ON DUPLICATE KEY UPDATE code=code;

INSERT INTO promo_codes (code, type, percent, active) VALUES ('SAVE10', 'percent', 10, 1)
  ON DUPLICATE KEY UPDATE code=code;


-- invoices (aka orders)
CREATE TABLE IF NOT EXISTS invoices (
  id            INT AUTO_INCREMENT PRIMARY KEY,
  user_id       INT NOT NULL,
  stripe_pi_id  VARCHAR(100) NOT NULL UNIQUE,
  amount_cents  INT NOT NULL,
  currency      VARCHAR(10) NOT NULL,
  status        VARCHAR(30) NOT NULL DEFAULT 'pending', -- pending|succeeded|failed|canceled
  created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

-- invoice items
CREATE TABLE IF NOT EXISTS invoice_items (
  id            INT AUTO_INCREMENT PRIMARY KEY,
  invoice_id    INT NOT NULL,
  product_id    INT NOT NULL,
  name          VARCHAR(255) NOT NULL,
  price_cents   INT NOT NULL,
  qty           INT NOT NULL,
  FOREIGN KEY (invoice_id) REFERENCES invoices(id) ON DELETE CASCADE
) ENGINE=InnoDB;


ALTER TABLE users ADD COLUMN is_admin TINYINT(1) NOT NULL DEFAULT 0;

